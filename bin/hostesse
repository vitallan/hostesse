#!/usr/bin/env ruby

require 'hostesse'
require 'hostesse/cli'
require 'readline'

cli      = Hostesse::Cli.new(ARGV[0] || Hostesse::Environment.default_target_file, '.')
messages = Hostesse::Cli::Messages.new(cli)

puts messages.welcome

# handle ctrl+c gracefully

trap('INT') { cli.at_exit }

Readline.completion_append_character = ''
Readline.completion_proc             = ->(s) {
  Dir[s + '*'].map { |inode|
    if File.directory? inode
      inode + '/'
    elsif inode =~ /#{ Regexp.quote(Hostesse::DEFAULT_HOSTS_FILE_SUFFIX) }$/
      inode[0..-Hostesse::DEFAULT_HOSTS_FILE_SUFFIX.size.succ]
    else
      nil
    end
  }.compact
}

new_hosts_file = cli.current_hosts_definition || ''

while line = Readline.readline(messages.ps1, true)
  line.strip!
  new_hosts_file = line unless line.empty?

  unless new_hosts_file.empty?
    begin
      cli.change_hosts(new_hosts_file)
      puts messages.change_hosts
    rescue Errno::EACCES
      puts messages.error_target_file_isnt_writable
    rescue => error
      puts messages.error_very_bad_error(error)
    end
  end
end

cli.at_exit
