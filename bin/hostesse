#!/usr/bin/env ruby

require 'hostesse'
require 'hostesse/cli'
require 'readline'

current_hosts = ''
target_file   = File.expand_path(ARGV[0] || Hostesse::Environment.default_target_file)

puts Hostesse::Cli::Messages.welcome(target_file, '.')
at_exit { puts Hostesse::Cli::Messages.exit }

# handle ctrl+c gracefully

trap('INT') { exit }

Readline.completion_append_character = ''
Readline.completion_proc             = ->(s) {
  Dir[s + '*'].map { |inode|
    if File.directory? inode
      inode + '/'
    elsif inode =~ /#{ Regexp.quote(Hostesse::DEFAULT_HOSTS_FILE_SUFFIX) }$/
      inode[0..-Hostesse::DEFAULT_HOSTS_FILE_SUFFIX.size.succ]
    else
      nil
    end
  }.compact
}

while line = Readline.readline('hostesse> ', true).strip
  current_hosts = line unless line.empty?

  unless current_hosts.empty?
    begin
      File.open(target_file, 'w') do |generated_hosts|
        parsed_hosts = Hostesse::SimpleTemplateEngine.new('.').parse(current_hosts)
        generated_hosts.write(parsed_hosts)
        if parsed_hosts =~ /ERROR/
          puts Hostesse::Cli::Messages.error_in_definition_file(target_file)
        end
      end

    rescue Errno::EACCES
      puts Hostesse::Cli::Messages.error_target_file_isnt_writable(target_file)

    rescue => error
      puts Hostesse::Cli::Messages.error_very_bad_error(error)

    end
  end
end
